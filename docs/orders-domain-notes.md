# Доменные заметки по заказам (для разработки)

Этот файл нужен, чтобы при работе над проектом помнить общую картинку и не ломать логику заказов.

## 1. Общая идея проекта

- Есть **существующий американский проект**: там пользователи заказывают товары из США.
- Этот проект — **продолжение для российского пользователя**:
  - Российский пользователь заказывает американские товары.
  - Товары сначала идут в США → далее отправляются в **Монголию** → из Монголии в Россию.
- Американская админка и наш проект **никак не связаны технически**:
  - Наш админ вручную создаёт заказ в американской системе.
  - В нашей админке он фиксирует только то, что важно **для российского/монгольского этапа**.

## 2. Структура заказа (OrderModel)

Ключевые поля (важные для домена):

- `mailBox: string | null`
  - Человекочитаемый ID заказа вида `M000123`.
  - Используется в интерфейсе **вместо Mongo `_id`** ("кракозябры").
  - Генерируется на бэкенде при создании заказа; старые заказы лениво получают `mailBox` при первом доступе.

- `externalOrderId: string | null`
  - Номер заказа **в американской админке**.
  - Нужен, чтобы админ мог быстро найти этот заказ на стороннем сайте.

- `shopUrl: string`
  - URL магазина/площадки, где был оформлен заказ (Amazon, eBay и т.п.).
  - В доменной логике это и есть **Shipper** (отправитель в США).
  - Фильтры по Shipper строятся именно на этом поле.

- `products: IOrderProduct[]`
  - Массив товаров **внутри документа заказа** (снепшот):
    - `name, brand, category, size, color, price, quantity, weight, width_x, height_y, depth_z`.
  - Отдельной коллекции `Product` **нет**; все нужные данные всегда лежат внутри заказа.

- `adressSnapshot`
  - Снимок адреса получателя **на момент создания/редактирования заказа**.
  - Изменение адреса в адресной книге **не меняет старые заказы**.
  - Из него важны поля: `deliveryMethod (warehouse|courier)`, `city`, ФИО, телефоны и т.д.

- `isBusiness: boolean`
  - Тип оформления: **физлицо** или **бизнес**.
  - Используется как Form type.

- `order_coast: number | null`, `paid: number | null`
  - `order_coast` — сумма счёта (вся логистика + маржа, одним числом).
  - `paid` — сколько реально оплачено по этому счёту.
  - По этим полям считается статус счёта: не оплачен / частично / оплачен.

- `paymentInfo?: { provider: "manual" | "yookassa" | "stripe" | "other"; externalId?: string; status: "pending" | "paid" | "failed" | "refunded"; paidAt?: Date }`
  - Метаданные платежа в платёжной системе (id транзакции, статус, дата оплаты).

- `isFinal: boolean`
  - Флаг, что заказ **финализирован** (по сути, история закончена и редактирование запрещено).

- `attachments`
  - Массив вложений: фото коробок, сканы, документы.
  - Пока используется как хранилище ссылок/метаданных; UI под загрузку/просмотр может быть доработан позже.

- `originBranchId?: ObjectId | null`
  - Склад/отделение **в Монголии**, куда посылка сначала приходит из США.
  - Отсюда мы отправляем её в Россию.
  - Фильтр `Department From` в админке опирается именно на это поле (монгольский склад отправления).

- `destinationBranchId?: ObjectId | null`
  - Склад/отделение **в России**, куда посылка приезжает из Монголии до передачи в СДЭК/другую службу внутри РФ.
  - Фильтр `Department To` в админке опирается на это поле (российский склад назначения).

## 3. Жизненный цикл заказа (укрупнённо)

1. **Фаза США (внешняя админка)**  
   - Пользователь оформляет заказ в американском сервисе.
   - Наш админ вручную создаёт соответствующий заказ у нас:
     - заполняет `externalOrderId` (номер в амер. системе),
     - заполняет `shopUrl`, товары, описание и т.п.
   - Статус у нас: `Created`.

2. **Фаза Монголия → Россия (наша зона ответственности)**  
   - Админ получает данные о посылке (вес/габариты из США/Монголии):
     - замеряются вес/габариты (`weight`, `width_x`, `height_y`, `depth_z`),
     - считается `order_coast` (стоимость доставки),
     - админ выставляет счёт ⇒ статус `Shipping approved`,
   - Пользователь оплачивает счёт (через платёжку) ДО прибытия товара:
     - `paid >= order_coast`, `paymentInfo.status = "paid"`, статус `Shipping paid`,
   - После оплаты посылка приходит на склад в Монголии:
     - админ ставит `originBranchId` (монгольский склад),
     - статус переводится в состояние прибытия `Arrived` (товар прибыл в Монголию после оплаты),
   - Отправка в Россию ⇒ статус `Departed`.

3. **Фаза РФ / СДЭК**  
   - Прибытие на российский склад:
     - заполняется `destinationBranchId` (российский склад),
     - статус снова может стать `Arrived` (уже для РФ).
   - Передача в СДЭК / локальную доставку по РФ:
     - статус `Delivered` (для нас: отдано в службу доставки).
   - Получение посылки пользователем:
     - статус `Received`,
     - `isFinal = true`.

## 4. Идентификаторы и что показываем пользователю

- Везде, где видит человек (пользователь или админ), **используем `mailBox`**, а не `_id`.
- Старые ссылки вида `/user/orders/<mongo-id>` поддерживаются на бэкенде за счёт поиска по `{$or: [{_id: id}, {mailBox: id}]}`.
- Новые ссылки на заказы нужно строить по `mailBox` (например, `/user/orders/M000123`).

## 5. Логика фильтров в админке (основные принципы)

- **Фильтры, которые точно поддерживаем:**
  - `Order ID` → `externalOrderId` (номер в американской админке).
  - `Mailbox` → `mailBox`.
  - `Tracking number` → `track`.
  - `Status` → `status`.
  - `Date From` / `Date To` → диапазон по `createdAt`.
  - `Shipment method` → `adressSnapshot.deliveryMethod` (warehouse/courier).
  - `Shop / Shipper` → `shopUrl`.
  - `Group ID` → `groupId`.
  - `Shelf` → `shelf`.
  - `Weight from/to` → диапазон по `weight`.
  - `Form type` → `isBusiness` (персональный/бизнес).
  - `Is final` → `isFinal`.
  - `Is paid invoice` → вычисляемый фильтр по `order_coast` и `paid` (не оплачен / частично / оплачен).
  - `Department From` → `originBranchId` (склад/отделение в Монголии).
  - `Department To` → `destinationBranchId` (склад/отделение в России).

## 6. Правила при дальнейшей разработке

- **Не возвращаться к `_id` в UI.** Если нужен ID заказа для пользователя или админа — используем `mailBox`. `externalOrderId` показываем как "номер в американской системе".
- **Все данные о товарах должны быть доступны из `order.products`.** Новые фичи не должны пытаться воссоздавать отдельную коллекцию продуктов.
- **Адрес получателя всегда читается из `adressSnapshot`**, а не из текущей адресной книги пользователя.
- **Фильтры в админке всегда должны опираться на реальные поля модели** (см. список выше), а не на "полузаглушки".
- При добавлении новых полей для логистики (например, трек по РФ, дополнительные статусы) — сначала:
  1. формулируем бизнес-смысл поля,
  2. добавляем его в `orderModel`,
  3. только затем делаем фильтры/колонки в админке.

## 7. Flights, Bags и отчёты (для будущего проектирования)

Этот раздел описывает упрощённую модель \"рейсов\" и мешков, чтобы позже спроектировать модели и интерфейсы.

### 7.1. Flight (рейс)

**Смысл:** объединяет несколько мешков (Bag) в одну логистическую отправку.  
Примеры: рейс США → Монголия или Монголия → Россия.

Минимальный набор полей:

- `code: string` — человекочитаемый код рейса (`DE-UBN-20251218`).
- `fromCountry: string`, `toCountry: string` — откуда / куда летит рейс.
- `plannedDepartureAt?: Date`, `plannedArrivalAt?: Date` — планируемые даты.
- `status: "Planned" | "In transit" | "Arrived" | "Closed"`.
- `bagsCount: number` — сколько мешков привязано.
- `totalWeightKg: number` — суммарный вес по всем мешкам (для отчётов).

Flight сам по себе не знает про заказы напрямую, он работает через Bags.

### 7.2. Bag (мешок / большая коробка)

**Смысл:** физическая единица груза, в которую складываются несколько заказов.

Поля:

- `name: string` — человекочитаемое имя мешка (`Exp-Dec182025-4035`).
- `weightKg: number` — общий вес мешка.
- `flightId?: ObjectId | null` — к какому рейсу привязан (может быть `null`, пока не привязали).
- `orderIds: string[]` — список заказов в мешке (можно хранить `mailBox` или `_id`).
- `createdAt: Date`.

В заказе (`OrderModel`) под это можно добавить поле:

- `bagId?: ObjectId | null` — в какой мешок упакован заказ (если уже упакован).

### 7.3. Manage Bags (привязка мешков к рейсу)

Экран по смыслу:

- показывает список мешков без `flightId` (ещё не привязанных к рейсу);
- позволяет выбрать галочками мешки и сохранить;
- после сохранения:
  - в мешках обновляется `flightId`,
  - у Flight пересчитываются `bagsCount` и `totalWeightKg`.

### 7.4. Bags List (реестр по мешкам)

Для каждого рейса нужен печатный/экранный список:

- по каждому мешку:
  - Bag # (name),
  - общий вес,
  - количество заказов;
- детализированный список по заказам в мешке:
  - `track`, `weight`, `mailBox`, ФИО/адрес/телефон получателя.

Это используется как акт приёмки/передачи между складами (пример — скрины Bags List).

### 7.5. Invoice (сводный инвойс по рейсу/мешку)

**Смысл:** один финансовый документ между компаниями (например, США → Монголия).

Минимальные поля:

- `flightId` или `bagId` — к чему относится инвойс.
- `shipperInfo` — реквизиты отправителя (адрес и контакты США).
- `receiverInfo` — реквизиты получателя (монгольская/российская компания).
- `items[]`:
  - `description: string` — описание позиции (`Shipping (Express)`, `Dimensions`, страховка и т.д.),
  - `amount: number` — сумма.
- `totalAmount: number`.
- `status: "draft" | "sent" | "paid"`.
- `createdAt: Date`, `paidAt?: Date`.

Инвойс можно формировать на основе веса и тарифов, а затем использовать и в Profit&Loss, и как отдельную печатную форму.

### 7.6. Packing List (список содержимого)

Packing List можно не хранить как отдельную сущность, а строить на основе данных:

- для выбранного `flightId`:
  - находим все `bags`,
  - по ним — все заказы,
  - и рендерим таблицу с колонками:
    - категории/товары,
    - отправитель (shopUrl, адрес),
    - получатель, адрес, телефон,
    - Mailbox, вес, признак `Is paid`.

Важно, что Packing List — это **отчётное представление**, а не новая сущность в базе.

### 7.7. Profit & Loss Report

Цель отчёта — видеть, сколько мы заработали на доставке (по заказу/мешку/рейсу).

Брать данные можно из:

- заказов (`order_coast`, `paid`, `paymentInfo`, `weight`),
- при необходимости — из инвойсов.

Строка отчёта может содержать:

- `mailBox` — ID заказа;
- `internalNumber` — внутренний номер/трек (при необходимости);
- `weight` — вес заказа;
- `datePaid` — `paymentInfo.paidAt`;
- `gateway` — `paymentInfo.provider` (TDB, Visa/MasterCard и т.д.);
- `amountTotal` — `paid`;
- `fee` / `feeAmount` — комиссия платёжки (можно добавить позже, по данным из платёжной системы).

Отчёт `Profit & Loss` — тоже **вычисляемый**, его можно строить по запросу, а не хранить отдельной коллекцией.




## ПОДРОБНОСТИ ПО ОПЛАТЕ
1. Пользователь создаёт заказ
Заполняет товары, сайт, адрес и т.д.
Ничего ещё не платит.
Статус: Created.

2. Админ считает финальную стоимость (ДО прибытия товара в Монголию)
На стороне США / Монголии появляются реальные данные:
вес / габариты,
тариф США → Монголия,
тариф Монголия → Россия,
примерный тариф СДЭК (по калькулятору, можно руками).
Админ суммирует всё (можно с запасом + маржа) и записывает в order_coast.
Статус: Shipping approved (счёт выставлен).

3. Пользователь оплачивает весь счёт сразу (ДО прибытия товара)
В интерфейсе он видит: «Оплатить X ₽» — это уже вся сумма, включая:
наши расходы США → Монголия → Россия,
нашу маржу,
ориентировочно СДЭК.
После успешной оплаты:
paid = order_coast,
paymentInfo.status = "paid",
статус заказа: Shipping paid.

4. После оплаты товар прибывает на склад в Монголии
Админ ставит originBranchId (монгольский склад),
статус переводится в Arrived (товар прибыл в Монголию после оплаты).

5. Дальше мы работаем только с уже оплаченным заказом
Отправляем из Монголии в Россию,
довозим до российского склада,
передаём в СДЭК.

## 8. Отчёты и аналитика (Reports)

Ниже перечислены основные отчётные разделы, которые нужно иметь в админке (по аналогии с американской версией), и откуда для них брать данные.

### 8.1. Self‑serve Report

**Смысл:** показать все заказы, созданные через \"самообслуживание\" (терминал/приложение), с привязкой к инвойсам и складам.

Колонки (идея):
- `Date` — дата создания / оплаты.
- `Order#` — внутренний номер заказа (у нас это может быть `mailBox` или отдельный счётчик).
- `Invoice#` — ID инвойса, связанного с заказом.
- `Stockroom` — склад/отделение, через которое оформлен заказ (используем отделения в США/Монголии/России).
- `Address` — адрес self‑serve точки / склада.
- `Charges Total` — дополнительные сборы (если будут).
- `Invoice Total` — сумма инвойса за доставку.
- `Invoice Payment Method` — способ оплаты (из `paymentInfo.provider`).

Источники данных:
- сами заказы + их инвойсы (`InvoiceModel`, когда появится),
- `paymentInfo` для payment method.

### 8.2. Delivery Report

**Смысл:** агрегированный отчёт по доставке **по рейсам**: сколько пакетов, вес, суммы по платёжкам.

Колонки:
- `Created` — дата создания записи/рейса.
- `Flight` — код рейса (`Flight.code`).
- `Department from` — отделение-отправитель (можно брать из `originBranchId` рейса/заказов).
- `Shipment method` — способ доставки (Express / SAL / Air и т.д.).
- `Packages` — количество пакетов (мешков) в рейсе.
- `Mailboxes` — количество заказов (по `mailBox`) в рейсе.
- `Weight` — суммарный вес (`Flight.totalWeightKg` или сумма по мешкам).
- `Splited` — количество \"расщеплённых\"/разделённых заказов (если будем поддерживать split).
- `Combined` — количество объединённых заказов (merge).
- `Amounts` — блок с суммами по платёжным типам (PayPal, Points, TDB, COD и т.д.).

Источники:
- `Flight` + связанные `Bag` + заказы (`order_coast`, `paid`, `paymentInfo.provider`).

### 8.3. Walkin Report

**Смысл:** отчёт по клиентам, которые пришли \"ногами\" в офис (walk‑in), с разбивкой по способу оплаты.

Колонки:
- `Stockroom` — офис/отделение.
- Для каждой payment type (Cash, Card, Collect и т.д.):
  - `PKG` — кол-во пакетов (заказов),
  - `KG` — общий вес,
  - `Sales` — сумма продаж.
- `Total sales`:
  - `Sales before commission`,
  - `Commission`,
  - `After commission`.

Источники:
- заказы, помеченные как Walk‑in (понадобится флажок в заказе или отдельная сущность).
- `paymentInfo` и `weight`.

### 8.4. Shelves history Report

**Смысл:** история использования полок на складах — когда какой заказ был поставлен на какую полку и когда снят.

Колонки:
- `Name` — имя полки (`shelf`).
- `Order` — ID заказа (у нас `mailBox` или `_id`).
- `Membership` — тип клиента (обычный/подписка, если будет).
- `Department` — отделение/склад.
- `Put date` — когда поставили на полку.
- `Removed date` — когда сняли с полки.

Это отдельная таблица движения по полкам (лог), а не просто поле `shelf` в заказе.  
Нужно будет:
- либо завести модель `ShelfHistory` с такими полями,
- либо писать события в общий лог с типом `shelf_put` / `shelf_removed`.

### 8.5. Summary Report

**Смысл:** сводный отчёт по типам оплат за период.

Колонки:
- `Payment type` — Square, COD, PayPal, Points, TDB, Bank, Cash via app, Zelle, и т.п.
- `Number of packages` — сколько заказов с этим типом оплаты.
- `Amount` — общая сумма по этим заказам (`paid`).

Источники:
- заказы с `paymentInfo.status = "paid"`,
- группировка по `paymentInfo.provider`.

Фильтры:
- период по дате доставки/оплаты,
- `Department from`,
- `Flight` (для привязки к конкретному рейсу).

### 8.6. Blocked emails Report

**Смысл:** лог e‑mail адресов, по которым не удалось отправить письмо (bounce), чтобы поддержка могла их править/разблокировать.

Колонки:
- `Email` — адрес получателя.
- `Order ID` — связанный заказ (если есть).
- `User mailbox` — Mailbox пользователя.
- `Status` — тип ошибки (Bounce, Suppressed и т.д.).
- `Message` — текст/код ошибки от почтового сервера.
- `Put date` — когда мы зафиксировали эту ошибку.
- `Actions` — кнопки, например:
  - \"показать\", \"удалить из списка\", \"пометить как исправленный\".

Источники:
- отдельная коллекция `BlockedEmail` (или аналогичная),
- заполняется при ошибках отправки писем (например, через логгер в почтовом сервисе).

### 8.7. Self‑serve Order view и Invoice

Карточка заказа в США (Self‑serve) по сути совпадает с тем, что мы уже описали:
- блок `Shipper info` — данные отправителя (почта, телефон, имя, страна, адрес);
- `Tracking info` — внешний трек + внутренний трек компании;
- `Recipient info` — страна, ФИО, ID, телефон, адрес получателя;
- `Order info` — вес посылки, стоимость, дополнительные поля;
- `Attachments` — фото коробки;
- `Order contents` — товары (категория, бренд, qty, цена).

Invoice в Self‑serve:
- это частный случай нашего инвойса (описан в разделе 7.5),
- берёт данные по конкретному заказу:
  - реквизиты отправителя/получателя,
  - список позиций (Shipping, Dimensions, Insurance),
  - итоговую сумму.

Для России/Монголии мы будем реализовывать аналогичный экран заказа и инвойса, но уже на базе нашей модели (`OrderModel` + `paymentInfo`).
